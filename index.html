<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finance Tracker</title>
  
  <!-- PWA Manifest & Theme -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#06b6d4">

  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #06b6d4;
      --accent-hover: #0ea5e9;
      --muted: #94a3b8;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --income-bg: rgba(6, 182, 212, 0.15);
      --expense-bg: rgba(239, 68, 68, 0.15);
      --text: #f1f5f9;
      --border: rgba(255, 255, 255, 0.08);
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      color: var(--text);
    }
    
    body {
      background: var(--bg);
      padding: 16px;
      line-height: 1.5;
    }
    
    .app {
      max-width: 1100px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, #06b6d4, #0ea5e9);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }
    
    .muted {
      color: var(--muted);
      font-size: 14px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (min-width: 1024px) {
      .grid {
        grid-template-columns: 320px 1fr 360px;
      }
    }
    
    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border);
    }
    
    .small {
      font-size: 14px;
      color: var(--muted);
    }
    
    input, select, textarea, button {
      font-family: inherit;
      font-size: 16px; /* Prevents zoom on iOS */
    }
    
    input[type="text"], input[type="number"], input[type="date"], input[type="search"], select, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      transition: all 0.2s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
    }
    
    button {
      background: var(--accent);
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      color: #0f172a;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    
    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
      border: none;
    }
    
    .btn-danger:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }
    
    .cust-list {
      max-height: 420px;
      overflow: auto;
      margin-top: 16px;
    }
    
    .cust-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .cust-item:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-1px);
    }
    
    .cust-item .left {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    
    .badge {
      font-weight: 700;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      min-width: 100px;
      text-align: center;
    }
    
    .balance-pos {
      background: var(--income-bg);
      color: #06b6d4;
    }
    
    .balance-neg {
      background: var(--expense-bg);
      color: #ef4444;
    }
    
    .ledger {
      max-height: 420px;
      overflow: auto;
      margin-top: 16px;
    }
    
    .txn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .txn:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-1px);
    }
    
    .txn .left {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    
    .txn .meta {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .summary {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    
    .stat {
      flex: 1;
      min-width: 120px;
      padding: 16px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
    }
    
    .stat .num {
      font-weight: 800;
      font-size: 20px;
      margin-top: 8px;
    }
    
    footer {
      margin-top: 24px;
      color: var(--muted);
      font-size: 14px;
      text-align: center;
      padding: 16px;
    }
    
    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .form-row > * {
      flex: 1;
      min-width: 120px;
    }
    
    .mobile-full {
      width: 100%;
    }
    
    @media (max-width: 767px) {
      .action-buttons {
        width: 100%;
        margin-top: 12px;
      }
      
      .action-buttons button {
        flex: 1;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .form-row > * {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Smart Budget App</h1>
        <div class="muted">Track income and expenses with customer management</div>
      </div>
      <div class="muted">Data saved locally in your browser</div>
    </header>

    <div class="grid">
      <!-- LEFT: Customers -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="small">Customers</div>
            <strong id="custCount">0</strong>
          </div>
          <div class="action-buttons">
            <button id="exportBtn">Export</button>
            <button id="importBtn" class="btn-ghost">Import</button>
            <input type="file" id="fileInput" accept="application/json" style="display:none" />
          </div>
        </div>

        <div class="form-row">
          <input id="newCustomer" type="text" placeholder="Customer name" autocomplete="off" maxlength="50" aria-label="New customer name" title="Type name and press Enter or click Add" onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('addCustomer').click();}" />
          <button id="addCustomer">Add</button>
        </div>

        <div class="cust-list" id="customers"></div>

        <hr />

        <div class="form-row">
          <input id="searchCustomer" type="search" placeholder="Search customers" 
                 autocomplete="off" maxlength="50" aria-label="Search customers" title="Type name and press Enter to search"
                 onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('applySearch').click();} else if(event.key==='Escape'){document.getElementById('clearSearch').click();}" />
          <div class="action-buttons mobile-full">
            <button id="applySearch" class="btn-ghost">Search</button>
            <button id="clearSearch" class="btn-ghost">Clear</button>
          </div>
        </div>
      </div>

      <!-- MIDDLE: Ledger / Txn -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="small">Active Customer</div>
            <strong id="activeName">— select a customer —</strong>
          </div>
          <div class="small">Balance: <span id="activeBalance">₹0.00</span></div>
        </div>

        <div class="form-row">
          <select id="txType">
            <option value="credit">Credit (Received)</option>
            <option value="debit">Debit (Paid)</option>
          </select>
          <input type="number" id="txAmount" placeholder="Amount (₹)" min="0" step="0.01" />
          <input type="date" id="txDate" />
        </div>

        <div style="margin-bottom: 12px;">
          <input type="text" id="txRemark"
            placeholder="Remark (optional)"
            maxlength="100" autocomplete="off" aria-label="Transaction remark"
            title="Who/from where — optional. Press Enter to add transaction"
            onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('addTx').click();}"
            list="remarkHints" />

          <datalist id="remarkHints">
            <option value="Monthly Expenses">
            <option value="Grocery payment">
            <option value="Fuel">
            <option value="FastFood">
            <option value="Other">
          </datalist>
        </div>

        <div class="form-row">
          <button id="addTx">Add Transaction</button>
          <button id="resetTx" class="btn-ghost">Reset</button>
          <button id="deleteAllCustTx" class="btn-danger" title="Delete all transactions of active customer">Delete All Tx</button>
        </div>

        <div class="summary" id="custSummary">
          <div class="stat"><div class="small">Total Credit</div><div class="num" id="custCredit">₹0.00</div></div>
          <div class="stat"><div class="small">Total Debit</div><div class="num" id="custDebit">₹0.00</div></div>
          <div class="stat"><div class="small">Balance</div><div class="num" id="custBal">₹0.00</div></div>
        </div>

        <div style="margin-top: 16px" class="small">Ledger (recent first)</div>
        <div class="ledger" id="ledger"></div>
      </div>

      <!-- RIGHT: Global summary -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="small">Global Summary</div>
            <strong id="globalCount">0</strong> customers
          </div>
        </div>

        <div style="margin-top: 16px">
          <div class="small">Overall income / expense</div>
          <div class="summary">
            <div class="stat">
              <div class="small">Income</div>
              <div class="num" id="globalIncome">₹0.00</div>
            </div>
            <div class="stat">
              <div class="small">Expense</div>
              <div class="num" id="globalExpense">₹0.00</div>
            </div>
          </div>
        </div>

        <hr />

        <div class="small">Quick actions</div>
        <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">
          <button id="exportAll" class="btn-ghost">Export All Data</button>
          <button id="clearAll" class="btn-danger">Clear All Data</button>
        </div>
      </div>
    </div>

    <footer>Data stored locally (localStorage). Export JSON to backup or move devices.</footer>
  </div>

<script>
/* Khatabook Customers & Ledger - Single file app
   Storage keys:
     - KEY_CUST: array of customers {id, name}
     - KEY_TX: array of transactions {id, custId, type:'credit'|'debit', amount, dateISO, remark}
*/
 /* --- Service Worker registration --- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered')).catch(err=>console.log('SW failed:',err));
}
/* --- App Code --- */

const KEY_CUST = 'kb_cust_v1'
const KEY_TX   = 'kb_tx_v1'

/* Utilities */
const $ = s => document.querySelector(s)
const uid = () => Math.random().toString(36).slice(2,9)
const fmt = n => '₹' + Number(n || 0).toFixed(2)

function load(key){ try{ return JSON.parse(localStorage.getItem(key)) || [] }catch(e){ return [] } }
function save(key, data){ localStorage.setItem(key, JSON.stringify(data)) }

/* App state */
let customers = load(KEY_CUST)
let transactions = load(KEY_TX)
let activeCustomerId = null

/* DOM refs */
const customersEl = $('#customers'), custCountEl = $('#custCount'), globalCountEl = $('#globalCount')
const activeNameEl = $('#activeName'), activeBalanceEl = $('#activeBalance'), ledgerEl = $('#ledger')
const custCreditEl = $('#custCredit'), custDebitEl = $('#custDebit'), custBalEl = $('#custBal')
const globalIncomeEl = $('#globalIncome'), globalExpenseEl = $('#globalExpense')

/* Init render */
renderCustomers()
renderGlobal()
renderActive(null)

/* Customer management */
$('#addCustomer').addEventListener('click', ()=>{
  const name = $('#newCustomer').value.trim()
  if(!name){ alert('Enter customer name'); return }
  if(customers.find(c=>c.name.toLowerCase()===name.toLowerCase())){ alert('Customer exists'); return }
  const c = {id: uid(), name}
  customers.push(c); save(KEY_CUST, customers)
  $('#newCustomer').value = ''
  renderCustomers()
})

$('#applySearch').addEventListener('click', ()=>{
  const q = $('#searchCustomer').value.trim().toLowerCase()
  renderCustomers(q)
})
$('#clearSearch').addEventListener('click', ()=>{
  $('#searchCustomer').value=''; renderCustomers()
})

function renderCustomers(filter=''){
  customersEl.innerHTML = ''
  const list = customers.filter(c => !filter || c.name.toLowerCase().includes(filter.toLowerCase()))
  custCountEl.textContent = list.length
  globalCountEl.textContent = customers.length
  // For each customer show name and quick balance
  list.forEach(c=>{
    const bal = customerBalance(c.id)
    const div = document.createElement('div'); div.className='cust-item'
    div.innerHTML = `
      <div class="left">
        <strong>${c.name}</strong>
        <div class="small">Transactions: ${transactions.filter(t=>t.custId===c.id).length}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="badge ${bal>=0?'balance-pos':'balance-neg'}">${fmt(bal)}</div>
        <button data-id="${c.id}" class="btn-ghost viewBtn">View</button>
        <button data-id="${c.id}" class="btn-ghost renameBtn">Rename</button>
        <button data-id="${c.id}" class="btn-danger delCustBtn">Delete</button>
      </div>
    `
    customersEl.appendChild(div)
  })
  // attach handlers (event delegation could be used; easier to re-query)
  document.querySelectorAll('.viewBtn').forEach(b=>b.onclick = (e)=>{ selectCustomer(b.dataset.id) })
  document.querySelectorAll('.delCustBtn').forEach(b=>b.onclick = (e)=>{ 
    const id = b.dataset.id
    if(!confirm('Delete customer and ALL their transactions? This cannot be undone.')) return
    // remove customer and their transactions
    customers = customers.filter(c=>c.id!==id)
    transactions = transactions.filter(t=>t.custId!==id)
    save(KEY_CUST, customers); save(KEY_TX, transactions)
    if(activeCustomerId === id) activeCustomerId = null
    renderCustomers(); renderGlobal(); renderActive(null)
  })
  document.querySelectorAll('.renameBtn').forEach(b=>b.onclick=(e)=>{
    const id = b.dataset.id; const c = customers.find(x=>x.id===id)
    const nm = prompt('Rename customer:', c.name); if(!nm) return
    c.name = nm.trim(); save(KEY_CUST, customers); renderCustomers(); if(activeCustomerId===id) renderActive(id)
  })
}

/* Select customer */
function selectCustomer(id){
  activeCustomerId = id
  renderActive(id)
}

/* Active customer view */
function renderActive(id){
  if(!id){ activeNameEl.textContent = '— select a customer —'; ledgerEl.innerHTML = ''; activeBalanceEl.textContent = fmt(0); custCreditEl.textContent = fmt(0); custDebitEl.textContent = fmt(0); custBalEl.textContent = fmt(0); return }
  const c = customers.find(x=>x.id===id)
  if(!c) return
  activeNameEl.textContent = c.name
  const custTx = transactions.filter(t=>t.custId===id).slice().sort((a,b)=>b.date.localeCompare(a.date))
  renderLedger(custTx)
  const credit = custTx.filter(t=>t.type==='credit').reduce((s,t)=>s+t.amount,0)
  const debit  = custTx.filter(t=>t.type==='debit').reduce((s,t)=>s+t.amount,0)
  const bal = credit - debit
  activeBalanceEl.textContent = fmt(bal)
  custCreditEl.textContent = fmt(credit)
  custDebitEl.textContent = fmt(debit)
  custBalEl.textContent = fmt(bal)
}

/* Ledger rendering */
function renderLedger(txns){
  ledgerEl.innerHTML = ''
  if(txns.length===0){ ledgerEl.innerHTML = '<div class="small muted">No transactions yet</div>'; return }
  txns.forEach(t=>{
    const div = document.createElement('div'); div.className='txn'
    div.innerHTML = `
      <div class="left">
        <div><strong>${t.type==='credit' ? 'Credit' : 'Debit'} • ${fmt(t.amount)}</strong></div>
        <div class="meta">${t.remark || '-'} • ${new Date(t.date).toLocaleString().replace(',','')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button data-id="${t.id}" class="btn-ghost editTx">Edit</button>
        <button data-id="${t.id}" class="btn-danger delTx">Delete</button>
      </div>
    `
    ledgerEl.appendChild(div)
  })
  // handlers
  document.querySelectorAll('.delTx').forEach(b=>b.onclick=(e)=>{
    const id = b.dataset.id
    if(!confirm('Delete this transaction?')) return
    transactions = transactions.filter(x=>x.id!==id)
    save(KEY_TX, transactions); renderActive(activeCustomerId); renderCustomers(); renderGlobal()
  })
  document.querySelectorAll('.editTx').forEach(b=>b.onclick=(e)=>{
    const id = b.dataset.id; const t = transactions.find(x=>x.id===id)
    // pre-fill form for editing
    $('#txType').value = t.type
    $('#txAmount').value = t.amount
    $('#txDate').value = t.date.slice(0,10)
    $('#txRemark').value = t.remark
    // set editing marker
    $('#addTx').dataset.edit = id
    $('#addTx').textContent = 'Save Changes'
  })
}

/* Transactions: add/edit */
$('#addTx').addEventListener('click', ()=>{
  if(!activeCustomerId){ alert('Select a customer first'); return }
  const type = $('#txType').value
  const amount = parseFloat($('#txAmount').value)
  if(isNaN(amount) || amount<=0){ alert('Enter valid amount'); return }
  const date = $('#txDate').value ? new Date($('#txDate').value+'T12:00').toISOString() : new Date().toISOString()
  const remark = $('#txRemark').value.trim()
  // editing?
  const editId = $('#addTx').dataset.edit
  if(editId){
    const tx = transactions.find(x=>x.id===editId)
    tx.type = type; tx.amount = amount; tx.date = date; tx.remark = remark
    delete $('#addTx').dataset.edit
    $('#addTx').textContent = 'Add Transaction'
  } else {
    const tx = { id: uid(), custId: activeCustomerId, type, amount, date, remark }
    transactions.push(tx)
  }
  save(KEY_TX, transactions)
  // reset form
  $('#txAmount').value=''; $('#txDate').value=''; $('#txRemark').value=''
  renderActive(activeCustomerId); renderCustomers(); renderGlobal()
})

$('#resetTx').addEventListener('click', ()=>{
  $('#txAmount').value=''; $('#txDate').value=''; $('#txRemark').value=''; delete $('#addTx').dataset.edit; $('#addTx').textContent='Add Transaction'
})

/* Delete all tx of active customer */
$('#deleteAllCustTx').addEventListener('click', ()=>{
  if(!activeCustomerId) return alert('Select a customer first')
  if(!confirm('Delete ALL transactions of this customer?')) return
  transactions = transactions.filter(t=>t.custId!==activeCustomerId)
  save(KEY_TX, transactions); renderActive(activeCustomerId); renderCustomers(); renderGlobal()
})

/* Helpers */
function customerBalance(custId){
  const tx = transactions.filter(t=>t.custId===custId)
  const credit = tx.filter(t=>t.type==='credit').reduce((s,x)=>s+x.amount,0)
  const debit  = tx.filter(t=>t.type==='debit').reduce((s,x)=>s+x.amount,0)
  return credit - debit
}

/* Global summary render */
function renderGlobal(){
  const income = transactions.filter(t=>t.type==='credit').reduce((s,t)=>s+t.amount,0)
  const expense = transactions.filter(t=>t.type==='debit').reduce((s,t)=>s+t.amount,0)
  globalIncomeEl.textContent = fmt(income)
  globalExpenseEl.textContent = fmt(expense)
  globalCountEl.textContent = customers.length
}

/* Export & Import */
$('#exportBtn').addEventListener('click', ()=>{
  const data = { customers, transactions }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'})
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a'); a.href=url; a.download='khatabook_customers_export.json'; a.click(); URL.revokeObjectURL(url)
})
$('#exportAll').addEventListener('click', ()=>$('#exportBtn').click())

$('#importBtn').addEventListener('click', ()=>$('#fileInput').click())
$('#fileInput').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return
  const rdr = new FileReader(); rdr.onload = ev=>{
    try{
      const imp = JSON.parse(ev.target.result)
      if(!imp.customers || !imp.transactions) return alert('Invalid file format')
      if(!confirm('Import will replace local data. Continue?')) return
      customers = imp.customers; transactions = imp.transactions
      save(KEY_CUST, customers); save(KEY_TX, transactions)
      activeCustomerId = null; renderCustomers(); renderGlobal(); renderActive(null); alert('Imported OK')
    }catch(err){ alert('Invalid JSON') }
  }; rdr.readAsText(f)
})

/* Clear All */
$('#clearAll').addEventListener('click', ()=>{
  if(!confirm('Clear ALL data (customers + transactions)?')) return
  customers = []; transactions = []; activeCustomerId = null
  save(KEY_CUST, customers); save(KEY_TX, transactions); renderCustomers(); renderGlobal(); renderActive(null)
})

/* Initial sample - optional: uncomment to seed sample data
if(customers.length===0){
  customers.push({id:uid(), name:'Ramesh'}); customers.push({id:uid(), name:'Shop A'}); save(KEY_CUST, customers)
}
*/

</script>
</body>
</html>